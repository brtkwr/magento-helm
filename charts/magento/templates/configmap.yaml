apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "magento.fullname" . }}-setup
  labels:
    {{- include "magento.labels" . | nindent 4 }}
data:
  setup.sh: |
    #!/bin/bash
    set -ex

    cd /var/www/html

    {{- if .Values.gitSync.plugins }}
    # Wait for git-sync to populate the repos
    echo "Waiting for git-sync..."
    {{- range .Values.gitSync.plugins }}
    while [ ! -L /var/www/html/git-sync/{{ .name }}/code ]; do
      sleep 2
    done
    {{- end }}
    echo "Git-sync ready"

    # Create symlinks for plugins
    {{- range .Values.gitSync.plugins }}
    mkdir -p $(dirname /var/www/html/{{ .path }})
    rm -rf /var/www/html/{{ .path }}
    ln -sf /var/www/html/git-sync/{{ .name }}/code /var/www/html/{{ .path }}
    echo "Symlink created: {{ .path }} -> git-sync/{{ .name }}/code"
    {{- end }}
    {{- end }}

    # Wait for database to be ready
    until mysql -h 127.0.0.1 -u {{ .Values.database.user }} -p"$MYSQL_PASSWORD" --skip-ssl -e "SELECT 1" &>/dev/null; do
      echo "Waiting for database..."
      sleep 5
    done

    # Wait for OpenSearch to be ready
    {{- if .Values.opensearch.enabled }}
    until curl -s http://127.0.0.1:9200/_cluster/health &>/dev/null; do
      echo "Waiting for OpenSearch..."
      sleep 5
    done
    echo "OpenSearch is ready"
    {{- end }}

    {{- if or .Values.hooks.preSetup }}
    # Hook: preSetup
{{ .Values.hooks.preSetup | indent 4 }}
    {{- end }}

    # Check if Magento is already installed
    if [ -f app/etc/env.php ]; then
      echo "Magento already installed, running upgrade..."

      # Backup env.php before upgrade (can get corrupted on failure)
      cp app/etc/env.php app/etc/env.php.bak

      bin/magento setup:upgrade || {
        echo "setup:upgrade failed, restoring env.php backup"
        cp app/etc/env.php.bak app/etc/env.php
        exit 1
      }

      bin/magento setup:di:compile || {
        echo "setup:di:compile failed, restoring env.php backup"
        cp app/etc/env.php.bak app/etc/env.php
        exit 1
      }

      # Validate env.php has install date (fix if corrupted)
      php -r "
        \$c = include 'app/etc/env.php';
        if (!isset(\$c['install']['date'])) {
          \$c['install'] = ['date' => date('r')];
          file_put_contents('app/etc/env.php', '<?php return '.var_export(\$c,true).';');
          echo \"Fixed missing install date in env.php\n\";
        }
      "
      apachectl -k graceful  # Reload Apache to clear opcache

      # Sync all admin users (idempotent - creates or updates)
      {{- range $i, $user := .Values.adminUsers }}
      bin/magento admin:user:create \
        --admin-firstname='{{ $user.firstname }}' \
        --admin-lastname='{{ $user.lastname }}' \
        --admin-email='{{ $user.email }}' \
        --admin-user='{{ $user.username }}' \
        --admin-password="${ADMIN_PASSWORD_{{ $i }}}" || true
      {{- end }}

      {{- if .Values.hooks.postUpgrade }}
      # Hook: postUpgrade
{{ .Values.hooks.postUpgrade | indent 6 }}
      {{- end }}
      {{- if or .Values.hooks.postSetup .Values.postScript }}
      # Hook: postSetup
      {{- if .Values.hooks.postSetup }}
{{ .Values.hooks.postSetup | indent 6 }}
      {{- end }}
      {{- if .Values.postScript }}
      # DEPRECATED postScript (use hooks.postSetup)
{{ .Values.postScript | indent 6 }}
      {{- end }}
      {{- end }}

      # Reindex after changes
      bin/magento indexer:reindex || true

      # Ensure config is synchronized after hooks
      bin/magento app:config:import --no-interaction || true

      bin/magento cache:flush
      bin/magento maintenance:disable
      chown -R www-data:www-data /var/www/html/var /var/www/html/generated /var/www/html/pub/static
      exit 0
    fi

    # Initial setup (uses first admin user as primary)
    {{- $primaryUser := index .Values.adminUsers 0 }}
    bin/magento setup:install \
      --base-url="https://{{ .Values.magento.host }}/" \
      --base-url-secure="https://{{ .Values.magento.host }}/" \
      --db-host='127.0.0.1' \
      --db-name='{{ .Values.database.name }}' \
      --db-user='{{ .Values.database.user }}' \
      --db-password="${MYSQL_PASSWORD}" \
      --admin-firstname='{{ $primaryUser.firstname }}' \
      --admin-lastname='{{ $primaryUser.lastname }}' \
      --admin-email='{{ $primaryUser.email }}' \
      --admin-user='{{ $primaryUser.username }}' \
      --admin-password="${ADMIN_PASSWORD_0}" \
      --language='{{ .Values.magento.language }}' \
      --currency='{{ .Values.magento.currency }}' \
      --timezone='{{ .Values.magento.timezone }}' \
      --use-rewrites='1' \
      --backend-frontname='admin' \
      {{- if .Values.opensearch.enabled }}
      --search-engine='opensearch' \
      --opensearch-host='127.0.0.1' \
      --opensearch-port='9200'
      {{- end }}

    # Disable 2FA for development
    bin/magento module:disable Magento_AdminAdobeImsTwoFactorAuth Magento_TwoFactorAuth || true

    bin/magento deploy:mode:set developer

    # SSL offloader config (Magento behind load balancer)
    bin/magento config:set web/secure/offloader_header X-Forwarded-Proto

    # Enable store codes in URLs (for multi-store setups with /store-code/ URLs)
    bin/magento config:set web/url/use_store 1

    # Copy sample data media files if present
    if [ -d /var/www/html/vendor/magento/sample-data-media/catalog ]; then
      cp -r /var/www/html/vendor/magento/sample-data-media/* /var/www/html/pub/media/
      echo "Sample data media files copied"
    fi

    bin/magento setup:upgrade
    bin/magento setup:di:compile
    apachectl -k graceful  # Reload Apache to clear opcache
    bin/magento catalog:images:resize || true  # Generate product image cache
    bin/magento indexer:reindex || true

    # Create additional admin users (skip first, already created by setup:install)
    {{- range $i, $user := .Values.adminUsers }}
    {{- if gt $i 0 }}
    bin/magento admin:user:create \
      --admin-firstname='{{ $user.firstname }}' \
      --admin-lastname='{{ $user.lastname }}' \
      --admin-email='{{ $user.email }}' \
      --admin-user='{{ $user.username }}' \
      --admin-password="${ADMIN_PASSWORD_{{ $i }}}" || true
    {{- end }}
    {{- end }}

    {{- if .Values.hooks.postInstall }}
    # Hook: postInstall
{{ .Values.hooks.postInstall | indent 4 }}
    {{- end }}
    {{- if or .Values.hooks.postSetup .Values.postScript }}
    # Hook: postSetup
    {{- if .Values.hooks.postSetup }}
{{ .Values.hooks.postSetup | indent 4 }}
    {{- end }}
    {{- if .Values.postScript }}
    # DEPRECATED postScript (use hooks.postSetup)
{{ .Values.postScript | indent 4 }}
    {{- end }}
    {{- end }}

    # Ensure config is synchronized after hooks
    bin/magento app:config:import --no-interaction || true

    bin/magento cache:flush
    bin/magento maintenance:disable
    chown -R www-data:www-data /var/www/html/var /var/www/html/generated /var/www/html/pub/static

    echo "Setup complete!"
