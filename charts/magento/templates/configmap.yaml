apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "magento.fullname" . }}-setup
  labels:
    {{- include "magento.labels" . | nindent 4 }}
data:
  # init-setup.sh runs in init container (blocking) - core Magento setup
  init-setup.sh: |
    #!/bin/bash
    set -e

    cd /var/www/html

    fix_permissions() {
      echo "Fixing permissions..."
      chown -R www-data:www-data var/ generated/ pub/static/ pub/media/ app/etc/ 2>/dev/null || true
      chmod -R 775 var/ generated/ 2>/dev/null || true
    }

    {{- if .Values.gitSync.plugins }}
    # Create symlinks for git-sync plugins
    echo "Setting up git-sync plugin symlinks..."
    {{- range .Values.gitSync.plugins }}
    mkdir -p $(dirname /var/www/html/{{ .path }})
    rm -rf /var/www/html/{{ .path }}
    ln -sf /var/www/html/git-sync/{{ .name }}/code /var/www/html/{{ .path }}
    echo "Symlink: {{ .path }} -> git-sync/{{ .name }}/code"
    {{- end }}
    {{- end }}

    # Wait for database (sidecar should be ready)
    echo "Waiting for database..."
    for i in $(seq 1 60); do
      if mysql -h 127.0.0.1 -u {{ .Values.database.user }} -p"$MYSQL_PASSWORD" --skip-ssl -e "SELECT 1" &>/dev/null; then
        echo "Database is ready"
        break
      fi
      if [ $i -eq 60 ]; then
        echo "ERROR: Database not ready after 60 attempts"
        exit 1
      fi
      sleep 2
    done

    {{- if .Values.opensearch.enabled }}
    # Wait for OpenSearch (sidecar should be ready)
    echo "Waiting for OpenSearch..."
    for i in $(seq 1 60); do
      if curl -s http://127.0.0.1:9200/_cluster/health &>/dev/null; then
        echo "OpenSearch is ready"
        break
      fi
      if [ $i -eq 60 ]; then
        echo "ERROR: OpenSearch not ready after 60 attempts"
        exit 1
      fi
      sleep 2
    done
    {{- end }}

    # Check if Magento is already installed
    if [ -f app/etc/env.php ]; then
      echo "=== UPGRADE PATH ==="

      # Backup env.php before upgrade
      cp app/etc/env.php app/etc/env.php.bak

      echo "Running setup:upgrade..."
      bin/magento setup:upgrade || {
        echo "setup:upgrade failed, restoring env.php backup"
        cp app/etc/env.php.bak app/etc/env.php
        exit 1
      }

      # Clean generated code
      rm -rf generated/code generated/metadata

      echo "Running setup:di:compile..."
      bin/magento setup:di:compile || {
        echo "setup:di:compile failed, restoring env.php backup"
        cp app/etc/env.php.bak app/etc/env.php
        exit 1
      }

      # Validate env.php has install date
      php -r "
        \$c = include 'app/etc/env.php';
        if (!isset(\$c['install']['date'])) {
          \$c['install'] = ['date' => date('r')];
          file_put_contents('app/etc/env.php', '<?php return '.var_export(\$c,true).';');
          echo \"Fixed missing install date in env.php\n\";
        }
      "

      # Set deploy mode
      bin/magento deploy:mode:set {{ .Values.magento.mode }} --skip-compilation || true

    else
      echo "=== FRESH INSTALL ==="

      {{- $primaryUser := index .Values.adminUsers 0 }}
      bin/magento setup:install \
        --base-url="https://{{ .Values.magento.host }}/" \
        --base-url-secure="https://{{ .Values.magento.host }}/" \
        --db-host='127.0.0.1' \
        --db-name='{{ .Values.database.name }}' \
        --db-user='{{ .Values.database.user }}' \
        --db-password="${MYSQL_PASSWORD}" \
        --admin-firstname='{{ $primaryUser.firstname }}' \
        --admin-lastname='{{ $primaryUser.lastname }}' \
        --admin-email='{{ $primaryUser.email }}' \
        --admin-user='{{ $primaryUser.username }}' \
        --admin-password="${ADMIN_PASSWORD_0}" \
        --language='{{ .Values.magento.language }}' \
        --currency='{{ .Values.magento.currency }}' \
        --timezone='{{ .Values.magento.timezone }}' \
        --use-rewrites='1' \
        --backend-frontname='admin' \
        {{- if .Values.opensearch.enabled }}
        --search-engine='opensearch' \
        --opensearch-host='127.0.0.1' \
        --opensearch-port='9200'
        {{- end }}

      # Disable 2FA for development
      bin/magento module:disable Magento_AdminAdobeImsTwoFactorAuth Magento_TwoFactorAuth || true

      # Set deploy mode
      bin/magento deploy:mode:set {{ .Values.magento.mode }} --skip-compilation || true

      # SSL offloader config
      bin/magento config:set web/secure/offloader_header X-Forwarded-Proto

      # Enable store codes in URLs
      bin/magento config:set web/url/use_store 1

      # Copy sample data media if present
      if [ -d /var/www/html/vendor/magento/sample-data-media/catalog ]; then
        cp -r /var/www/html/vendor/magento/sample-data-media/* /var/www/html/pub/media/
        echo "Sample data media files copied"
      fi

      bin/magento setup:upgrade
      bin/magento setup:di:compile

      # Mark as fresh install for postStart hooks
      touch /var/www/html/var/.fresh-install
    fi

    # Sync all admin users (idempotent)
    echo "Syncing admin users..."
    {{- range $i, $user := .Values.adminUsers }}
    bin/magento admin:user:create \
      --admin-firstname='{{ $user.firstname }}' \
      --admin-lastname='{{ $user.lastname }}' \
      --admin-email='{{ $user.email }}' \
      --admin-user='{{ $user.username }}' \
      --admin-password="${ADMIN_PASSWORD_{{ $i }}}" || true
    {{- end }}

    fix_permissions
    bin/magento maintenance:disable || true

    # Create marker file for postStart hook
    touch /var/www/html/var/.init-setup-complete

    echo "=== INIT SETUP COMPLETE ==="

  # setup.sh runs in postStart (async) - hooks and final cleanup only
  setup.sh: |
    #!/bin/bash
    set -e

    cd /var/www/html

    fix_permissions() {
      chown -R www-data:www-data var/ generated/ pub/static/ pub/media/ app/etc/ 2>/dev/null || true
      chmod -R 775 var/ generated/ 2>/dev/null || true
    }

    # Wait for init-setup to complete (marker file)
    echo "Waiting for init-setup to complete..."
    for i in $(seq 1 120); do
      if [ -f /var/www/html/var/.init-setup-complete ]; then
        echo "Init setup complete, running hooks..."
        break
      fi
      if [ $i -eq 120 ]; then
        echo "WARNING: Init setup marker not found, proceeding anyway"
        break
      fi
      sleep 2
    done

    {{- if .Values.hooks.preSetup }}
    # Hook: preSetup
    echo "Running preSetup hook..."
{{ .Values.hooks.preSetup | indent 4 }}
    {{- end }}

    # Determine if fresh install or upgrade
    INSTALL_TYPE="upgrade"
    if [ -f /var/www/html/var/.fresh-install ]; then
      INSTALL_TYPE="install"
      rm -f /var/www/html/var/.fresh-install
    fi

    if [ "$INSTALL_TYPE" = "install" ]; then
      {{- if .Values.hooks.postInstall }}
      # Hook: postInstall
      echo "Running postInstall hook..."
{{ .Values.hooks.postInstall | indent 6 }}
      {{- end }}
    else
      {{- if .Values.hooks.postUpgrade }}
      # Hook: postUpgrade
      echo "Running postUpgrade hook..."
{{ .Values.hooks.postUpgrade | indent 6 }}
      {{- end }}
    fi

    {{- if or .Values.hooks.postSetup .Values.postScript }}
    # Hook: postSetup
    echo "Running postSetup hook..."
    {{- if .Values.hooks.postSetup }}
{{ .Values.hooks.postSetup | indent 4 }}
    {{- end }}
    {{- if .Values.postScript }}
    # DEPRECATED postScript (use hooks.postSetup)
{{ .Values.postScript | indent 4 }}
    {{- end }}
    {{- end }}

    # Final cleanup
    echo "Running final cleanup..."
    bin/magento app:config:import --no-interaction || true
    bin/magento indexer:reindex || true
    bin/magento cache:flush
    bin/magento maintenance:disable || true
    fix_permissions

    # Reload Apache to pick up any changes
    apachectl -k graceful || true

    echo "=== SETUP COMPLETE ==="
